const axios = require('axios');

async function testSystemStatus() {
    console.log('üîç [TEST] Verificando estado del sistema despu√©s de correcciones...\n');
    
    const services = [
        { name: 'QBTC Core', url: 'http://localhost:4602/health' },
        { name: 'Monitor de Gr√°ficos', url: 'http://localhost:4606/health' },
        { name: 'SRONA API', url: 'http://localhost:4601/health' },
        { name: 'Frontend API', url: 'http://localhost:4603/health' },
        { name: 'Vigo Futures', url: 'http://localhost:4604/health' },
        { name: 'Dashboard QBTC', url: 'http://localhost:4605/health' }
    ];
    
    console.log('üìä Verificando servicios:');
    for (const service of services) {
        try {
            const response = await axios.get(service.url, { timeout: 5000 });
            console.log(`‚úÖ ${service.name}: ${response.status} - ${response.data.status || 'OK'}`);
        } catch (error) {
            console.log(`‚ùå ${service.name}: ${error.code || error.message}`);
        }
    }
    
    console.log('\nüìà Verificando endpoints de datos:');
    
    // Test QBTC Core endpoints
    try {
        const futuresResponse = await axios.get('http://localhost:4602/api/futures-data', { timeout: 10000 });
        console.log(`‚úÖ QBTC Futures Data: ${futuresResponse.status} - ${Object.keys(futuresResponse.data.data || {}).length} s√≠mbolos`);
    } catch (error) {
        console.log(`‚ùå QBTC Futures Data: ${error.response?.status || error.code || error.message}`);
    }
    
    try {
        const spotResponse = await axios.get('http://localhost:4602/api/spot-data', { timeout: 10000 });
        console.log(`‚úÖ QBTC Spot Data: ${spotResponse.status} - ${Object.keys(spotResponse.data.data || {}).length} s√≠mbolos`);
    } catch (error) {
        console.log(`‚ùå QBTC Spot Data: ${error.response?.status || error.code || error.message}`);
    }
    
    // Test Binance connection
    console.log('\nüåê Verificando conexi√≥n a Binance:');
    try {
        const binanceResponse = await axios.get('https://fapi.binance.com/fapi/v1/ticker/24hr', {
            timeout: 10000,
            headers: {
                'User-Agent': 'QBTC-Test/1.0',
                'Accept': 'application/json'
            }
        });
        console.log(`‚úÖ Binance API: ${binanceResponse.status} - ${binanceResponse.data.length} s√≠mbolos`);
        
        // Verificar algunos s√≠mbolos espec√≠ficos
        const btcData = binanceResponse.data.find(item => item.symbol === 'BTCUSDT');
        if (btcData) {
            console.log(`‚úÖ BTCUSDT: $${btcData.lastPrice} (${btcData.priceChangePercent}%)`);
        }
    } catch (error) {
        console.log(`‚ùå Binance API: ${error.response?.status || error.code || error.message}`);
        if (error.response?.status === 418) {
            console.log('‚ö†Ô∏è Rate limiting detectado - esperar antes de reintentar');
        }
    }
    
    console.log('\nüéØ Estado del sistema verificado');
}

testSystemStatus().catch(console.error);
