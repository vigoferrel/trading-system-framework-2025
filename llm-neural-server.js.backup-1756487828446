/**
 * ğŸ§  LLM NEURAL SERVER - SERVIDOR DE PRUEBA
 * ========================================
 * 
 * Servidor de prueba para el LLM Neural Orchestrator
 * que integra Google Gemini Flash 1.5 como cerebro maestro
 */

const express = require('express');
const cors = require('cors');
const { LLMNeuralOrchestrator } = require('./llm-neural-orchestrator');

const app = express();
const PORT = 4607; // Puerto para el servidor LLM Neural

app.use(cors());
app.use(express.json());

// Instancia del orquestador LLM
const llmOrchestrator = new LLMNeuralOrchestrator();

// Inicializar sistemas neuronales al arrancar
let isInitialized = false;

async function initializeOrchestrator() {
    if (!isInitialized) {
        console.log('ğŸš€ [LLM NEURAL SERVER] Inicializando orquestador...');
        await llmOrchestrator.initializeNeuralSystems();
        isInitialized = true;
        console.log('âœ… [LLM NEURAL SERVER] Orquestador inicializado');
    }
}

// Endpoint de salud
app.get('/health', (req, res) => {
    res.json({
        status: 'OK',
        service: 'LLM Neural Orchestrator Server',
        timestamp: new Date().toISOString(),
        initialized: isInitialized,
        stats: llmOrchestrator.getSystemStats()
    });
});

// Endpoint principal para generar decisiones unificadas
app.get('/api/unified-decision/:symbol', async (req, res) => {
    try {
        await initializeOrchestrator();
        
        const symbol = req.params.symbol.toUpperCase();
        console.log(`ğŸ§  [LLM NEURAL SERVER] Generando decisiÃ³n unificada para ${symbol}...`);
        
        const decision = await llmOrchestrator.generateUnifiedDecision(symbol);
        
        res.json({
            success: true,
            data: decision,
            timestamp: new Date().toISOString()
        });
        
    } catch (error) {
        console.error('âŒ [LLM NEURAL SERVER] Error:', error.message);
        res.status(500).json({
            success: false,
            error: error.message,
            timestamp: new Date().toISOString()
        });
    }
});

// Endpoint para mÃºltiples sÃ­mbolos
app.post('/api/batch-decisions', async (req, res) => {
    try {
        await initializeOrchestrator();
        
        const { symbols = ['BTCUSDT', 'ETHUSDT', 'BNBUSDT'] } = req.body;
        console.log(`ğŸ§  [LLM NEURAL SERVER] Generando decisiones para ${symbols.length} sÃ­mbolos...`);
        
        const decisions = {};
        
        for (const symbol of symbols) {
            try {
                decisions[symbol] = await llmOrchestrator.generateUnifiedDecision(symbol);
            } catch (error) {
                console.warn(`âš ï¸ Error con ${symbol}:`, error.message);
                decisions[symbol] = {
                    error: error.message,
                    symbol: symbol,
                    timestamp: new Date().toISOString()
                };
            }
        }
        
        res.json({
            success: true,
            data: decisions,
            timestamp: new Date().toISOString()
        });
        
    } catch (error) {
        console.error('âŒ [LLM NEURAL SERVER] Error en batch:', error.message);
        res.status(500).json({
            success: false,
            error: error.message,
            timestamp: new Date().toISOString()
        });
    }
});

// Endpoint para estadÃ­sticas del sistema
app.get('/api/system-stats', (req, res) => {
    res.json({
        success: true,
        data: llmOrchestrator.getSystemStats(),
        timestamp: new Date().toISOString()
    });
});

// Endpoint para limpiar cache
app.post('/api/clear-cache', (req, res) => {
    try {
        llmOrchestrator.clearCache();
        res.json({
            success: true,
            message: 'Cache limpiado correctamente',
            timestamp: new Date().toISOString()
        });
    } catch (error) {
        res.status(500).json({
            success: false,
            error: error.message,
            timestamp: new Date().toISOString()
        });
    }
});

// Endpoint de prueba con datos simulados
app.get('/api/test-decision', async (req, res) => {
    try {
        await initializeOrchestrator();
        
        console.log('ğŸ§  [LLM NEURAL SERVER] Generando decisiÃ³n de prueba...');
        
        // Simular seÃ±ales neuronales para prueba
        const testSignals = {
            symbol: 'BTCUSDT',
            timestamp: new Date().toISOString(),
            session: {
                primary_session: 'american',
                session_intensity: 0.95,
                overlaps: [{ name: 'EUROPE_AMERICA_POWER_HOUR', intensity: 1.0 }],
                optimal_strategies: ['NEWS_TRADING', 'HIGH_LEVERAGE', 'SCALPING']
            },
            psychological: {
                estado: 'EXTREME_GREED',
                confianza: 85.0,
                accion_recomendada: 'STRONG_SELL',
                senales_medibles: {
                    funding_rate: 5.00,
                    volume_spike: 1.20,
                    volatilidad: 80.0,
                    open_interest: 1.10
                }
            },
            quantum: {
                coherence: 80.0,
                consciousness: 82.5,
                entanglement: 72.5,
                superposition: 74.0,
                tunneling: 66.0
            },
            halving: {
                current_phase: 'BULL_MARKET_PHASE',
                days_to_next_halving: 150,
                halving_influence: 0.8
            },
            lunar: {
                lunar: {
                    phase: 'WAXING_GIBBOUS',
                    influence: {
                        volatility_factor: 0.75,
                        volume_multiplier: 1.2
                    }
                }
            }
        };
        
        // Formatear para Gemini
        const geminiPrompt = llmOrchestrator.formatNeuralSignalsForGemini(testSignals, 'BTCUSDT');
        
        // Consultar Gemini
        const geminiDecision = await llmOrchestrator.geminiBrain.analyzeAndDecide(geminiPrompt);
        
        // Validar y formatear
        const unifiedDecision = llmOrchestrator.validateAndFormatGeminiResponse(geminiDecision, testSignals);
        
        res.json({
            success: true,
            data: {
                test_signals: testSignals,
                gemini_prompt: geminiPrompt,
                gemini_response: geminiDecision,
                unified_decision: unifiedDecision
            },
            timestamp: new Date().toISOString()
        });
        
    } catch (error) {
        console.error('âŒ [LLM NEURAL SERVER] Error en prueba:', error.message);
        res.status(500).json({
            success: false,
            error: error.message,
            timestamp: new Date().toISOString()
        });
    }
});

// Endpoint para informaciÃ³n del sistema
app.get('/api/system-info', (req, res) => {
    res.json({
        success: true,
        data: {
            service: 'LLM Neural Orchestrator Server',
            version: '1.0.0',
            llm_provider: 'Google Gemini Flash 1.5',
            model: 'google/gemini-flash-1.5-8b',
            features: [
                'UnificaciÃ³n de seÃ±ales neuronales',
                'ResoluciÃ³n de contradicciones con LLM',
                'Cache inteligente',
                'Sistema de fallback',
                'AnÃ¡lisis psicolÃ³gico integrado',
                'MÃ©tricas cuÃ¡nticas',
                'Patrones temporales'
            ],
            endpoints: [
                'GET /health - Estado del servidor',
                'GET /api/unified-decision/:symbol - DecisiÃ³n unificada',
                'POST /api/batch-decisions - MÃºltiples decisiones',
                'GET /api/system-stats - EstadÃ­sticas',
                'POST /api/clear-cache - Limpiar cache',
                'GET /api/test-decision - Prueba con datos simulados',
                'GET /api/system-info - InformaciÃ³n del sistema'
            ]
        },
        timestamp: new Date().toISOString()
    });
});

// Manejo de errores global
app.use((error, req, res, next) => {
    console.error('âŒ [LLM NEURAL SERVER] Error no manejado:', error);
    res.status(500).json({
        success: false,
        error: 'Error interno del servidor',
        timestamp: new Date().toISOString()
    });
});

// Iniciar servidor
app.listen(PORT, () => {
    console.log('='.repeat(60));
    console.log('ğŸ§  LLM NEURAL ORCHESTRATOR SERVER');
    console.log('='.repeat(60));
    console.log(`ğŸš€ Servidor iniciado en puerto ${PORT}`);
    console.log(`ğŸŒ URL: http://localhost:${PORT}`);
    console.log(`ğŸ”— Health: http://localhost:${PORT}/health`);
    console.log(`ğŸ§  DecisiÃ³n: http://localhost:${PORT}/api/unified-decision/BTCUSDT`);
    console.log(`ğŸ“Š Stats: http://localhost:${PORT}/api/system-stats`);
    console.log(`ğŸ§ª Test: http://localhost:${PORT}/api/test-decision`);
    console.log('='.repeat(60));
    console.log('ğŸ’¡ Usando Google Gemini Flash 1.5 como cerebro maestro');
    console.log('ğŸ’¡ Integrando todos los sistemas neuronales existentes');
    console.log('ğŸ’¡ Resolviendo contradicciones con IA avanzada');
    console.log('='.repeat(60));
});

module.exports = app;
