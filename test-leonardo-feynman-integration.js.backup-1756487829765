/**
 * TEST LEONARDO-FEYNMAN QBTC INTEGRATION
 * ======================================
 * 
 * Script de prueba para validar la integraci√≥n del sistema Leonardo-Feynman
 * con datos reales de Binance y el sistema QBTC existente
 */

const { startLeonardoFeynmanQBTC } = require('./leonardo-feynman-integration');
const axios = require('axios');

async function testLeonardoFeynmanIntegration() {
    console.log('üß™ [TEST] Iniciando prueba de integraci√≥n Leonardo-Feynman QBTC...\n');
    
    try {
        // PASO 1: Verificar conectividad del servidor QBTC
        console.log('üì° [TEST] Verificando conectividad del servidor QBTC...');
        const healthResponse = await axios.get('http://localhost:4602/api/enhanced-opportunities', { timeout: 5000 });
        console.log('‚úÖ [TEST] Servidor QBTC conectado correctamente\n');
        
        // PASO 2: Inicializar sistema Leonardo-Feynman
        console.log('üé®üî¨ [TEST] Inicializando sistema Leonardo-Feynman...');
        const leonardoFeynmanSystem = await startLeonardoFeynmanQBTC();
        console.log('‚úÖ [TEST] Sistema Leonardo-Feynman inicializado\n');
        
        // PASO 3: Obtener lista de s√≠mbolos reales
        console.log('üìä [TEST] Obteniendo lista de s√≠mbolos reales...');
        const marketDataResponse = await axios.get('http://localhost:4602/api/market-data');
        
        if (!marketDataResponse.data.success) {
            throw new Error('No se pudieron obtener datos de mercado');
        }
        
        const symbols = Object.keys(marketDataResponse.data.data.futures || {});
        console.log(`‚úÖ [TEST] Obtenidos ${symbols.length} s√≠mbolos reales\n`);
        
        // PASO 4: Probar an√°lisis de s√≠mbolos individuales
        console.log('üß† [TEST] Probando an√°lisis de s√≠mbolos individuales...');
        const testSymbols = symbols.slice(0, 5); // Probar con 5 s√≠mbolos
        
        for (const symbol of testSymbols) {
            const marketData = marketDataResponse.data.data.futures[symbol];
            
            if (marketData) {
                const analysis = await leonardoFeynmanSystem.analyzeSymbol(symbol, marketData);
                
                console.log(`üìà [TEST] ${symbol}:`);
                console.log(`   Psicolog√≠a: ${analysis.psychology}`);
                console.log(`   Confianza: ${(analysis.confidence * 100).toFixed(1)}%`);
                console.log(`   Recomendaci√≥n: ${analysis.recommendation.action}`);
                console.log(`   Raz√≥n: ${analysis.reasoning}`);
                
                if (analysis.recommendation.entryPrice) {
                    console.log(`   Entrada: $${analysis.recommendation.entryPrice.toFixed(4)}`);
                    console.log(`   Stop Loss: $${analysis.recommendation.stopLoss.toFixed(4)}`);
                    console.log(`   Take Profit: $${analysis.recommendation.takeProfit.toFixed(4)}`);
                }
                console.log('');
            }
        }
        
        // PASO 5: Probar an√°lisis masivo
        console.log('üöÄ [TEST] Probando an√°lisis masivo de s√≠mbolos...');
        const massAnalysis = await leonardoFeynmanSystem.analyzeAllSymbols(symbols.slice(0, 20));
        
        console.log(`‚úÖ [TEST] An√°lisis masivo completado:`);
        console.log(`   Total analizados: ${massAnalysis.totalAnalyzed}`);
        console.log(`   Recomendaciones alta confianza: ${massAnalysis.highConfidenceRecommendations.length}`);
        console.log(`   Distribuci√≥n psicol√≥gica:`, massAnalysis.psychologyDistribution);
        console.log(`   Salud del sistema: ${massAnalysis.systemHealth.health}\n`);
        
        // PASO 6: Mostrar recomendaciones de alta confianza
        if (massAnalysis.highConfidenceRecommendations.length > 0) {
            console.log('üèÜ [TEST] Top 5 Recomendaciones de Alta Confianza:');
            massAnalysis.highConfidenceRecommendations
                .sort((a, b) => b.confidence - a.confidence)
                .slice(0, 5)
                .forEach((rec, index) => {
                    console.log(`   ${index + 1}. ${rec.symbol} - ${rec.recommendation.action} (${(rec.confidence * 100).toFixed(1)}%)`);
                    console.log(`      Psicolog√≠a: ${rec.psychology}`);
                    console.log(`      Raz√≥n: ${rec.reasoning}`);
                });
            console.log('');
        }
        
        // PASO 7: Verificar estado del sistema
        console.log('üìä [TEST] Verificando estado del sistema...');
        const systemStatus = leonardoFeynmanSystem.getSystemStatus();
        
        console.log(`‚úÖ [TEST] Estado del sistema:`);
        console.log(`   Psicolog√≠a actual: ${systemStatus.psychologyDetector.currentState}`);
        console.log(`   Confianza: ${(systemStatus.psychologyDetector.confidence * 100).toFixed(1)}%`);
        console.log(`   Estados analizados: ${systemStatus.psychologyDetector.statesAnalyzed}`);
        console.log(`   Salud: ${systemStatus.health.health}`);
        console.log(`   S√≠mbolos en historial: ${systemStatus.health.totalSymbols}`);
        console.log(`   Puntos de datos: ${systemStatus.health.totalDataPoints}\n`);
        
        // PASO 8: Validaci√≥n de integraci√≥n
        console.log('üîç [TEST] Validando integraci√≥n con QBTC...');
        
        // Verificar que el sistema puede acceder a datos reales
        const testSymbol = symbols[0];
        const testData = marketDataResponse.data.data.futures[testSymbol];
        
        if (testData && testData.price && testData.volume) {
            console.log(`‚úÖ [TEST] Integraci√≥n con datos reales verificada:`);
            console.log(`   S√≠mbolo: ${testSymbol}`);
            console.log(`   Precio: $${testData.price}`);
            console.log(`   Volumen: ${testData.volume}`);
            console.log(`   Cambio: ${testData.priceChangePercent}%`);
        } else {
            console.warn('‚ö†Ô∏è [TEST] Datos de prueba incompletos');
        }
        
        console.log('\nüéØ [TEST] Validaci√≥n de integraci√≥n Leonardo-Feynman QBTC completada exitosamente!');
        
        return {
            success: true,
            system: leonardoFeynmanSystem,
            analysis: massAnalysis,
            status: systemStatus,
            summary: {
                symbolsAnalyzed: massAnalysis.totalAnalyzed,
                highConfidenceRecommendations: massAnalysis.highConfidenceRecommendations.length,
                systemHealth: massAnalysis.systemHealth.health,
                integrationStatus: 'SUCCESS'
            }
        };
        
    } catch (error) {
        console.error('‚ùå [TEST] Error en prueba de integraci√≥n Leonardo-Feynman:', error.message);
        return {
            success: false,
            error: error.message
        };
    }
}

// Funci√≥n para comparar con sistema QBTC existente
async function compareWithQBTCSystem() {
    console.log('\nüîÑ [COMPARISON] Comparando Leonardo-Feynman con sistema QBTC existente...\n');
    
    try {
        // Obtener recomendaciones del sistema QBTC existente
        const qbtcResponse = await axios.get('http://localhost:4602/api/consolidated-recommendations');
        
        if (!qbtcResponse.data.success) {
            throw new Error('No se pudieron obtener recomendaciones QBTC');
        }
        
        const qbtcRecommendations = qbtcResponse.data.data.recommendations;
        
        console.log(`üìä [COMPARISON] Sistema QBTC existente:`);
        console.log(`   Total recomendaciones: ${qbtcRecommendations.length}`);
        console.log(`   Top 3: ${qbtcRecommendations.slice(0, 3).map(r => `${r.symbol}(${r.confidence})`).join(', ')}`);
        
        // Inicializar Leonardo-Feynman
        const leonardoFeynmanSystem = await startLeonardoFeynmanQBTC();
        
        // Analizar los mismos s√≠mbolos
        const qbtcSymbols = qbtcRecommendations.map(r => r.symbol);
        const lfAnalysis = await leonardoFeynmanSystem.analyzeAllSymbols(qbtcSymbols);
        
        console.log(`\nüé®üî¨ [COMPARISON] Sistema Leonardo-Feynman:`);
        console.log(`   Total analizados: ${lfAnalysis.totalAnalyzed}`);
        console.log(`   Alta confianza: ${lfAnalysis.highConfidenceRecommendations.length}`);
        console.log(`   Top 3: ${lfAnalysis.highConfidenceRecommendations.slice(0, 3).map(r => `${r.symbol}(${(r.confidence * 100).toFixed(1)}%)`).join(', ')}`);
        
        // Comparar enfoques
        console.log(`\nüìà [COMPARISON] An√°lisis comparativo:`);
        console.log(`   QBTC: Enfoque cu√°ntico-multidimensional`);
        console.log(`   Leonardo-Feynman: Enfoque psicol√≥gico-emp√≠rico`);
        console.log(`   Complementariedad: Alta (diferentes perspectivas)`);
        
        return {
            qbtcRecommendations: qbtcRecommendations.length,
            leonardoFeynmanRecommendations: lfAnalysis.highConfidenceRecommendations.length,
            comparison: 'COMPLEMENTARY_APPROACHES'
        };
        
    } catch (error) {
        console.error('‚ùå [COMPARISON] Error en comparaci√≥n:', error.message);
        return { error: error.message };
    }
}

// Ejecutar pruebas
async function runAllTests() {
    console.log('üß™ INICIANDO SUITE DE PRUEBAS LEONARDO-FEYNMAN QBTC\n');
    
    const integrationTest = await testLeonardoFeynmanIntegration();
    
    if (integrationTest.success) {
        const comparisonTest = await compareWithQBTCSystem();
        
        console.log('\nüìã RESUMEN DE PRUEBAS:');
        console.log(`‚úÖ Integraci√≥n Leonardo-Feynman: ${integrationTest.success ? 'EXITOSA' : 'FALLIDA'}`);
        console.log(`üìä S√≠mbolos analizados: ${integrationTest.summary?.symbolsAnalyzed || 0}`);
        console.log(`üéØ Recomendaciones alta confianza: ${integrationTest.summary?.highConfidenceRecommendations || 0}`);
        console.log(`üè• Salud del sistema: ${integrationTest.summary?.systemHealth || 'UNKNOWN'}`);
        
        if (comparisonTest.comparison) {
            console.log(`üîÑ Comparaci√≥n con QBTC: ${comparisonTest.comparison}`);
        }
        
        console.log('\nüé®üî¨ Leonardo-Feynman QBTC Integration est√° listo para producci√≥n!');
    } else {
        console.error('‚ùå Las pruebas fallaron. Revisar configuraci√≥n del sistema.');
    }
}

// Ejecutar si es el archivo principal
if (require.main === module) {
    runAllTests().catch(console.error);
}

module.exports = {
    testLeonardoFeynmanIntegration,
    compareWithQBTCSystem,
    runAllTests
};
