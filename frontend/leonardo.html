
// Constantes físicas reales del sistema
const PHYSICAL_CONSTANTS = {
  "QUANTUM_COHERENCE": 0.75,
  "QUANTUM_CONSCIOUSNESS": 0.8,
  "QUANTUM_ENTANGLEMENT": 0.65,
  "QUANTUM_SUPERPOSITION": 0.7,
  "QUANTUM_TUNNELING": 0.6,
  "MARKET_VOLATILITY": 0.05,
  "MARKET_MOMENTUM": 0.1,
  "MARKET_LIQUIDITY": 0.75,
  "MARKET_SPREAD": 0.001,
  "MARKET_DEPTH": 500000,
  "FUNDING_RATE": 0.02,
  "FUNDING_VOLATILITY": 0.01,
  "FUNDING_DEVIATION": 0.5,
  "FUNDING_ANNUALIZED": 5,
  "LIQUIDATION_PROBABILITY": 0.05,
  "SLIPPAGE_RATE": 0.0025,
  "VOLATILITY_RISK": 0.1,
  "EXECUTION_RISK": 0.005,
  "VOLUME_24H": 500000,
  "VOLUME_RATIO": 0.75,
  "VOLUME_EXPANSION": 300000,
  "PRICE_CHANGE": 0.02,
  "PRICE_ACCELERATION": 0.015,
  "PRICE_MOMENTUM": 0.01,
  "TIME_TO_FUNDING": 1800000,
  "SESSION_INTENSITY": 0.6,
  "TEMPORAL_RESONANCE": 0.7,
  "FIBONACCI_STRENGTH": 0.75,
  "FIBONACCI_INDEX": 5,
  "NEURAL_CONFIDENCE": 0.85,
  "NEURAL_COHERENCE": 0.8,
  "NEURAL_ENTANGLEMENT": 0.7,
  "BASE_LEVERAGE": 15,
  "CONSERVATIVE_LEVERAGE": 10,
  "AGGRESSIVE_LEVERAGE": 25,
  "STOP_LOSS": 0.03,
  "TAKE_PROFIT": 0.06,
  "BASE_SCORE": 0.65,
  "CONFIDENCE_SCORE": 0.75,
  "QUALITY_SCORE": 0.8
};

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leonardo Quantum Liberation Engine</title>
    <style>
        :root {
            --primary-color: #4a00e0;
            --secondary-color: #8e2de2;
            --accent-color: #ff9966;
            --bg-color: #0c0c14;
            --card-bg: #14141f;
            --text-color: #f0f0f0;
            --border-color: #2a2a3a;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 0;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
        }
        
        h1 {
            margin: 0;
            font-size: 2.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .tagline {
            font-style: italic;
            margin-top: 10px;
            opacity: 0.9;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }
        
        .card h2 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
        }
        
        .card h2 i {
            margin-right: 10px;
            color: var(--accent-color);
        }
        
        .status {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-on {
            background-color: #4CAF50;
            box-shadow: 0 0 8px #4CAF50;
        }
        
        .status-off {
            background-color: #F44336;
            box-shadow: 0 0 8px #F44336;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
            display: inline-flex;
            align-items: center;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e, #38ef7d);
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .metric {
            text-align: center;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }
        
        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 10px 0;
            color: var(--accent-color);
        }
        
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: var(--card-bg);
            border-radius: 5px;
            overflow: hidden;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background-color: rgba(0, 0, 0, 0.2);
            font-weight: bold;
        }
        
        tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .positive {
            color: #4CAF50;
        }
        
        .negative {
            color: #F44336;
        }
        
        .neutral {
            color: #FFC107;
        }
        
        .risk-profile {
            display: flex;
            align-items: center;
            margin-top: 20px;
        }
        
        .risk-profile select {
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 5px;
            margin-right: 10px;
        }
        
        .opportunity-form {
            margin-top: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .opportunity-form input, .opportunity-form select {
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 5px;
        }
        
        .opportunity-form button {
            grid-column: span 2;
        }
        
        .log-container {
            background-color: #0a0a12;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid var(--secondary-color);
        }
        
        .log-timestamp {
            color: #888;
            margin-right: 10px;
        }
        
        .footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            opacity: 0.7;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .opportunity-form {
                grid-template-columns: 1fr;
            }
            
            .opportunity-form button {
                grid-column: 1;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>Leonardo Quantum Liberation Engine</h1>
            <p class="tagline">"La simplicidad es la máxima sofisticación" - Leonardo da Vinci</p>
        </div>
    </header>
    
    <div class="container">
        <div class="dashboard">
            <div class="card">
                <h2><i class="fas fa-server"></i> Estado del Sistema</h2>
                <div class="status">
                    <div class="status-indicator status-off" id="system-status-indicator"></div>
                    <span id="system-status-text">Desconectado</span>
                </div>
                <div>
                    <button class="btn btn-success" id="start-system"><i class="fas fa-play"></i> Iniciar Sistema</button>
                    <button class="btn btn-danger" id="stop-system"><i class="fas fa-stop"></i> Detener Sistema</button>
                </div>
                <div class="metrics">
                    <div class="metric">
                        <div class="metric-label">Modo Trading</div>
                        <div class="metric-value" id="trade-mode">-</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Perfil de Riesgo</div>
                        <div class="metric-value" id="risk-profile-value">-</div>
                    </div>
                </div>
                <div class="risk-profile">
                    <select id="risk-profile-select">
                        <option value="conservative">Conservador</option>
                        <option value="balanced" selected>Balanceado</option>
                        <option value="aggressive">Agresivo</option>
                    </select>
                    <button class="btn" id="set-risk-profile"><i class="fas fa-check"></i> Aplicar</button>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-chart-line"></i> Métricas de Rendimiento</h2>
                <div class="metrics">
                    <div class="metric">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-value" id="win-rate">0%</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Profit Total</div>
                        <div class="metric-value" id="total-profit">0.00</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Trades</div>
                        <div class="metric-value" id="total-trades">0</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Drawdown</div>
                        <div class="metric-value" id="max-drawdown">0%</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-wallet"></i> Posiciones Activas</h2>
                <div id="active-positions-container">
                    <p>No hay posiciones activas</p>
                </div>
                <button class="btn btn-danger" id="close-all-positions"><i class="fas fa-times-circle"></i> Cerrar Todas</button>
            </div>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-lightbulb"></i> Procesar Oportunidad</h2>
            <form class="opportunity-form" id="opportunity-form">
                <input type="text" placeholder="Símbolo (ej. BTC)" id="opportunity-symbol" required>
                <select id="opportunity-direction" required>
                    <option value="LONG">LONG</option>
                    <option value="SHORT">SHORT</option>
                </select>
                <input type="number" placeholder="Score (0.0-1.0)" id="opportunity-score" min="0" max="1" step="0.01" value="0.7">
                <input type="number" placeholder="Edge (0.0-1.0)" id="opportunity-edge" min="0" max="1" step="0.01" value="0.5">
                <button type="submit" class="btn"><i class="fas fa-rocket"></i> Procesar Oportunidad</button>
            </form>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-history"></i> Historial de Trades</h2>
            <div id="trade-history-container">
                <p>No hay historial de trades</p>
            </div>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-terminal"></i> Log del Sistema</h2>
            <div class="log-container" id="system-log">
                <div class="log-entry">
                    <span class="log-timestamp">[00:00:00]</span>
                    <span>Sistema Leonardo Quantum Liberation Engine inicializado</span>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="footer">
        <div class="container">
            <p>Leonardo Quantum Liberation Engine &copy; 2023 - "La simplicidad es la máxima sofisticación"</p>
        </div>
    </footer>
    
    <script>
        // Variables globales
        let wsConnected = false;
        let ws = null;
        const systemLog = document.getElementById('system-log');
        
        // Función para agregar entrada al log
        function addLogEntry(message) {
            const now = new Date();
            const timestamp = now.toTimeString().split(' ')[0];
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span><span>${message}</span>`;
            systemLog.appendChild(logEntry);
            systemLog.scrollTop = systemLog.scrollHeight;
        }
        
        // Función para conectar WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            addLogEntry(`Conectando a WebSocket: ${wsUrl}`);
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                wsConnected = true;
                addLogEntry('Conexión WebSocket establecida');
                
                // Enviar ping periódico
                setInterval(() => {
                    if (wsConnected) {
                        ws.send(JSON.stringify({ type: 'ping' }));
                    }
                }, 30000);
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'pong') {
                        // Ignorar mensajes pong
                        return;
                    }
                    
                    if (data.type === 'system_status') {
                        updateSystemStatus(data.data);
                    }
                    
                    if (data.type === 'error') {
                        addLogEntry(`Error: ${data.message}`);
                    }
                    
                    console.log('WebSocket message:', data);
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };
            
            ws.onclose = () => {
                wsConnected = false;
                addLogEntry('Conexión WebSocket cerrada');
                
                // Reintentar conexión después de 5 segundos
                setTimeout(connectWebSocket, 5000);
            };
            
            ws.onerror = (error) => {
                wsConnected = false;
                addLogEntry(`Error WebSocket: ${error.message || 'Error desconocido'}`);
            };
        }
        
        // Función para enviar mensaje WebSocket
        function sendWebSocketMessage(type, data = {}) {
            if (!wsConnected) {
                addLogEntry('No hay conexión WebSocket');
                return;
            }
            
            const message = {
                type,
                ...data
            };
            
            ws.send(JSON.stringify(message));
        }
        
        // Función para actualizar el estado del sistema en la UI
        function updateSystemStatus(status) {
            const statusIndicator = document.getElementById('system-status-indicator');
            const statusText = document.getElementById('system-status-text');
            const tradeMode = document.getElementById('trade-mode');
            const riskProfile = document.getElementById('risk-profile-value');
            const winRate = document.getElementById('win-rate');
            const totalProfit = document.getElementById('total-profit');
            const totalTrades = document.getElementById('total-trades');
            const maxDrawdown = document.getElementById('max-drawdown');
            
            // Actualizar indicador de estado
            if (status.isRunning) {
                statusIndicator.className = 'status-indicator status-on';
                statusText.textContent = 'Conectado';
            } else {
                statusIndicator.className = 'status-indicator status-off';
                statusText.textContent = 'Desconectado';
            }
            
            // Actualizar métricas
            tradeMode.textContent = status.tradeMode || '-';
            riskProfile.textContent = status.riskProfile || '-';
            
            // Actualizar métricas de rendimiento
            if (status.metrics) {
                winRate.textContent = `${(status.metrics.winRate * 100).toFixed(1)}%`;
                totalProfit.textContent = status.metrics.totalProfit.toFixed(2);
                totalTrades.textContent = status.metrics.totalTrades || 0;
                maxDrawdown.textContent = `${status.metrics.maxDrawdown.toFixed(2)}%`;
            }
            
            // Actualizar posiciones activas
            updateActivePositions(status.components?.quantumTrader?.activePositions || []);
            
            // Actualizar historial de trades
            updateTradeHistory(status.components?.quantumTrader?.tradeHistory || []);
            
            addLogEntry(`Estado actualizado: ${status.isRunning ? 'Activo' : 'Inactivo'}`);
        }
        
        // Función para actualizar posiciones activas
        function updateActivePositions(positions) {
            const container = document.getElementById('active-positions-container');
            
            if (!positions || positions.length === 0) {
                container.innerHTML = '<p>No hay posiciones activas</p>';
                return;
            }
            
            let html = '<table>';
            html += '<tr><th>Símbolo</th><th>Lado</th><th>Tamaño</th><th>Entrada</th><th>PnL</th><th>Acciones</th></tr>';
            
            positions.forEach(position => {
                const pnlClass = position.pnl > 0 ? 'positive' : position.pnl < 0 ? 'negative' : 'neutral';
                
                html += `<tr>
                    <td>${position.symbol}</td>
                    <td>${position.side}</td>
                    <td>${position.size}</td>
                    <td>${position.entryPrice}</td>
                    <td class="${pnlClass}">${position.pnl ? position.pnl.toFixed(2) : '0.00'}</td>
                    <td><button class="btn btn-danger btn-sm close-position" data-id="${position.id}">Cerrar</button></td>
                </tr>`;
            });
            
            html += '</table>';
            container.innerHTML = html;
            
            // Agregar event listeners a los botones de cerrar posición
            document.querySelectorAll('.close-position').forEach(button => {
                button.addEventListener('click', () => {
                    const positionId = button.getAttribute('data-id');
                    closePosition(positionId);
                });
            });
        }
        
        // Función para actualizar historial de trades
        function updateTradeHistory(trades) {
            const container = document.getElementById('trade-history-container');
            
            if (!trades || trades.length === 0) {
                container.innerHTML = '<p>No hay historial de trades</p>';
                return;
            }
            
            let html = '<table>';
            html += '<tr><th>Símbolo</th><th>Lado</th><th>Entrada</th><th>Salida</th><th>PnL</th></tr>';
            
            trades.forEach(trade => {
                const pnlClass = trade.pnl > 0 ? 'positive' : trade.pnl < 0 ? 'negative' : 'neutral';
                
                html += `<tr>
                    <td>${trade.symbol}</td>
                    <td>${trade.side}</td>
                    <td>${trade.entryPrice}</td>
                    <td>${trade.exitPrice || '-'}</td>
                    <td class="${pnlClass}">${trade.pnl ? trade.pnl.toFixed(2) : '0.00'}</td>
                </tr>`;
            });
            
            html += '</table>';
            container.innerHTML = html;
        }
        
        // Función para iniciar el sistema
        function startSystem() {
            addLogEntry('Iniciando sistema...');
            sendWebSocketMessage('start_system');
        }
        
        // Función para detener el sistema
        function stopSystem() {
            addLogEntry('Deteniendo sistema...');
            sendWebSocketMessage('stop_system');
        }
        
        // Función para establecer perfil de riesgo
        function setRiskProfile() {
            const profile = document.getElementById('risk-profile-select').value;
            addLogEntry(`Estableciendo perfil de riesgo: ${profile}`);
            sendWebSocketMessage('set_risk_profile', { profile });
        }
        
        // Función para cerrar todas las posiciones
        function closeAllPositions() {
            addLogEntry('Cerrando todas las posiciones...');
            sendWebSocketMessage('close_all_positions');
        }
        
        // Función para cerrar una posición específica
        function closePosition(positionId) {
            addLogEntry(`Cerrando posición: ${positionId}`);
            
            fetch(`/api/close-position/${positionId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLogEntry(`Posición cerrada: ${positionId}`);
                } else {
                    addLogEntry(`Error al cerrar posición: ${data.error}`);
                }
            })
            .catch(error => {
                addLogEntry(`Error al cerrar posición: ${error.message}`);
            });
        }
        
        // Función para procesar oportunidad
        function processOpportunity(event) {
            event.preventDefault();
            
            const symbol = document.getElementById('opportunity-symbol').value;
            const direction = document.getElementById('opportunity-direction').value;
            const score = parseFloat(document.getElementById('opportunity-score').value);
            const edge = parseFloat(document.getElementById('opportunity-edge').value);
            
            const opportunity = {
                symbol,
                direction,
                score,
                edge
            };
            
            addLogEntry(`Procesando oportunidad: ${symbol} ${direction} (Score: ${score}, Edge: ${edge})`);
            sendWebSocketMessage('process_opportunity', { opportunity });
        }
        
        // Event Listeners
        document.getElementById('start-system').addEventListener('click', startSystem);
        document.getElementById('stop-system').addEventListener('click', stopSystem);
        document.getElementById('set-risk-profile').addEventListener('click', setRiskProfile);
        document.getElementById('close-all-positions').addEventListener('click', closeAllPositions);
        document.getElementById('opportunity-form').addEventListener('submit', processOpportunity);
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            addLogEntry('Interfaz Leonardo Quantum Liberation Engine inicializada');
            connectWebSocket();
            
            // Cargar estado inicial
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    updateSystemStatus(data);
                })
                .catch(error => {
                    addLogEntry(`Error al cargar estado inicial: ${error.message}`);
                });
        });
    </script>
</body>
</html>
