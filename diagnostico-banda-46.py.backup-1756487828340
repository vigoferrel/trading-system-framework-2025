#!/usr/bin/env python3
"""
DIAGN√ìSTICO - SISTEMA QBTC BANDA 46
Script para diagnosticar problemas espec√≠ficos en el sistema
"""

import subprocess
import time
import sys
import os
import socket
from datetime import datetime

def print_banner():
    """Imprime el banner del diagn√≥stico."""
    print("=" * 80)
    print("üîç DIAGN√ìSTICO - SISTEMA QBTC BANDA 46")
    print("=" * 80)
    print(f"üìÖ Fecha: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("üéØ Banda: 46")
    print("üîó Puertos: 4601-4606")
    print("üîß Identificaci√≥n de problemas espec√≠ficos")
    print("=" * 80)

def check_python_version():
    """Verifica la versi√≥n de Python."""
    print("üêç VERIFICANDO VERSI√ìN DE PYTHON")
    print("-" * 50)
    
    version = sys.version_info
    print(f"Python {version.major}.{version.minor}.{version.micro}")
    
    if version.major == 3 and version.minor >= 8:
        print("‚úÖ Versi√≥n de Python compatible")
    else:
        print("‚ùå Versi√≥n de Python no compatible (requiere 3.8+)")
    
    print()

def check_dependencies():
    """Verifica las dependencias necesarias."""
    print("üì¶ VERIFICANDO DEPENDENCIAS")
    print("-" * 50)
    
    dependencies = [
        ('aiohttp', 'aiohttp'),
        ('psutil', 'psutil'),
        ('sqlite3', 'sqlite3'),
        ('json', 'json'),
        ('datetime', 'datetime'),
        ('asyncio', 'asyncio')
    ]
    
    missing_deps = []
    
    for dep_name, import_name in dependencies:
        try:
            __import__(import_name)
            print(f"‚úÖ {dep_name}")
        except ImportError:
            print(f"‚ùå {dep_name} - NO INSTALADO")
            missing_deps.append(dep_name)
    
    if missing_deps:
        print(f"\n‚ö†Ô∏è Dependencias faltantes: {', '.join(missing_deps)}")
        print("üí° Instalar con: pip install " + " ".join(missing_deps))
    else:
        print("\n‚úÖ Todas las dependencias est√°n instaladas")
    
    print()

def check_scripts_exist():
    """Verifica que los scripts necesarios existan."""
    print("üìÅ VERIFICANDO SCRIPTS")
    print("-" * 50)
    
    scripts = [
        'srona-api-server.py',
        'frontend-api-server.py',
        'vigo-futures-server.py',
        'dashboard-http.py',
        'monitor-graficos-server-simple.py',
        'deploy-banda-46-fixed.py'
    ]
    
    missing_scripts = []
    
    for script in scripts:
        if os.path.exists(script):
            print(f"‚úÖ {script}")
        else:
            print(f"‚ùå {script} - NO ENCONTRADO")
            missing_scripts.append(script)
    
    if missing_scripts:
        print(f"\n‚ö†Ô∏è Scripts faltantes: {', '.join(missing_scripts)}")
    else:
        print("\n‚úÖ Todos los scripts est√°n presentes")
    
    print()

def check_ports_status():
    """Verifica el estado de los puertos."""
    print("üîå VERIFICANDO ESTADO DE PUERTOS")
    print("-" * 50)
    
    ports = [4601, 4602, 4603, 4604, 4605, 4606]
    busy_ports = []
    
    for port in ports:
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(2)
            result = sock.connect_ex(('localhost', port))
            sock.close()
            
            if result == 0:
                print(f"‚ùå Puerto {port} - OCUPADO")
                busy_ports.append(port)
            else:
                print(f"‚úÖ Puerto {port} - LIBRE")
                
        except Exception as e:
            print(f"‚ö†Ô∏è Puerto {port} - ERROR: {e}")
    
    if busy_ports:
        print(f"\n‚ö†Ô∏è Puertos ocupados: {busy_ports}")
        print("üí° Comando para liberar: taskkill /F /IM python.exe")
    else:
        print("\n‚úÖ Todos los puertos est√°n libres")
    
    print()

def check_processes():
    """Verifica procesos relacionados con QBTC."""
    print("üîÑ VERIFICANDO PROCESOS")
    print("-" * 50)
    
    try:
        # Buscar procesos Python relacionados con QBTC
        result = subprocess.run(
            'tasklist /FI "IMAGENAME eq python.exe" /FO CSV',
            shell=True,
            capture_output=True,
            text=True,
            timeout=10
        )
        
        if result.stdout:
            lines = result.stdout.strip().split('\n')[1:]  # Saltar encabezado
            qbtc_processes = []
            
            for line in lines:
                if line and 'python.exe' in line:
                    parts = line.split(',')
                    if len(parts) >= 2:
                        pid = parts[1].strip('"')
                        qbtc_processes.append(pid)
            
            if qbtc_processes:
                print(f"‚ö†Ô∏è Encontrados {len(qbtc_processes)} procesos Python:")
                for pid in qbtc_processes:
                    print(f"   - PID: {pid}")
                print("üí° Comando para terminar: taskkill /F /IM python.exe")
            else:
                print("‚úÖ No hay procesos Python ejecut√°ndose")
        else:
            print("‚úÖ No hay procesos Python ejecut√°ndose")
            
    except Exception as e:
        print(f"‚ö†Ô∏è Error verificando procesos: {e}")
    
    print()

def test_individual_services():
    """Prueba servicios individuales."""
    print("üß™ PROBANDO SERVICIOS INDIVIDUALES")
    print("-" * 50)
    
    services = [
        {
            "name": "Monitor de Gr√°ficos",
            "script": "monitor-graficos-server-simple.py",
            "port": 4606
        }
    ]
    
    for service in services:
        print(f"\nüîç Probando {service['name']}...")
        
        if not os.path.exists(service["script"]):
            print(f"‚ùå Script no encontrado: {service['script']}")
            continue
        
        try:
            # Iniciar servicio en proceso separado
            process = subprocess.Popen(
                [sys.executable, service["script"]],
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                text=True
            )
            
            # Esperar un momento
            time.sleep(5)
            
            # Verificar si est√° corriendo
            if process.poll() is None:
                print(f"‚úÖ {service['name']} iniciado correctamente")
                
                # Verificar puerto
                try:
                    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                    sock.settimeout(2)
                    result = sock.connect_ex(('localhost', service["port"]))
                    sock.close()
                    
                    if result == 0:
                        print(f"‚úÖ Puerto {service['port']} respondiendo")
                    else:
                        print(f"‚ùå Puerto {service['port']} no responde")
                        
                except Exception as e:
                    print(f"‚ö†Ô∏è Error verificando puerto: {e}")
                
                # Terminar proceso
                process.terminate()
                process.wait(timeout=5)
                print(f"üõë {service['name']} detenido")
                
            else:
                stdout, stderr = process.communicate()
                print(f"‚ùå Error iniciando {service['name']}")
                if stderr:
                    print(f"   Error: {stderr}")
                    
        except Exception as e:
            print(f"‚ùå Error probando {service['name']}: {e}")
    
    print()

def generate_report():
    """Genera un reporte de diagn√≥stico."""
    print("üìä REPORTE DE DIAGN√ìSTICO")
    print("-" * 50)
    
    print("üéØ RECOMENDACIONES:")
    print("1. ‚úÖ Usar Python 3.8+")
    print("2. ‚úÖ Instalar dependencias: pip install aiohttp psutil")
    print("3. ‚úÖ Verificar que todos los scripts existan")
    print("4. ‚úÖ Liberar puertos ocupados: taskkill /F /IM python.exe")
    print("5. ‚úÖ Usar deploy-banda-46-fixed.py para despliegue")
    print("6. ‚úÖ Usar monitor-graficos-server-simple.py (no el original)")
    
    print("\nüîß COMANDOS √öTILES:")
    print("‚Ä¢ Limpiar procesos: taskkill /F /IM python.exe")
    print("‚Ä¢ Instalar dependencias: pip install aiohttp psutil")
    print("‚Ä¢ Desplegar sistema: python deploy-banda-46-fixed.py")
    print("‚Ä¢ Probar monitor: python monitor-graficos-server-simple.py")
    print("‚Ä¢ Verificar puertos: netstat -ano | findstr :4606")
    
    print("\nüì± ACCESO A SERVICIOS:")
    print("‚Ä¢ Monitor de Gr√°ficos: http://localhost:4606")
    print("‚Ä¢ Dashboard QBTC: http://localhost:4605")
    print("‚Ä¢ SRONA API: http://localhost:4601")
    print("‚Ä¢ Frontend API: http://localhost:4603")
    print("‚Ä¢ Vigo Futures: http://localhost:4604")

def main():
    """Funci√≥n principal."""
    print_banner()
    
    # Ejecutar diagn√≥sticos
    check_python_version()
    check_dependencies()
    check_scripts_exist()
    check_ports_status()
    check_processes()
    test_individual_services()
    
    # Generar reporte
    generate_report()
    
    print("\n" + "=" * 80)
    print("üéØ DIAGN√ìSTICO COMPLETADO")
    print("=" * 80)

if __name__ == "__main__":
    main()
