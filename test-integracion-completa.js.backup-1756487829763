/**
 * ğŸ§ª TEST INTEGRACIÃ“N COMPLETA - NÃšCLEO PSICOLÃ“GICO
 * ================================================
 * 
 * Script de prueba para la integraciÃ³n completa del nÃºcleo psicolÃ³gico
 * con tasas de cambio de patrones fundamentales
 */

const { IntegracionNucleoPsicologico } = require('./integracion-nucleo-psicologico.js');

async function testIntegracionCompleta() {
    console.log('ğŸ§ª [TEST INTEGRACIÃ“N COMPLETA] Iniciando prueba del nÃºcleo psicolÃ³gico...');
    
    try {
        // ğŸš€ INICIALIZAR INTEGRACIÃ“N
        const integracion = new IntegracionNucleoPsicologico();
        
        // â³ ESPERAR INICIALIZACIÃ“N
        console.log('â³ Esperando inicializaciÃ³n del sistema...');
        await new Promise(resolve => setTimeout(resolve, 5000));
        
        // ğŸ“Š MOSTRAR ESTADO INICIAL
        console.log('\nğŸ“Š [TEST] Estado inicial del sistema:');
        const estadoInicial = integracion.obtenerEstadoGlobal();
        console.log('âœ… Ãšltima actualizaciÃ³n:', estadoInicial.ultimaActualizacion || 'N/A');
        console.log('ğŸ§  Estado psicolÃ³gico:', estadoInicial.estadoPsicologicoActual?.estado_global?.emocion || 'N/A');
        console.log('ğŸ¯ Oportunidades detectadas:', estadoInicial.oportunidadesDetectadas?.length || 0);
        console.log('ğŸš¨ Alertas activas:', estadoInicial.alertasPsicologicas?.length || 0);
        
        // ğŸ”„ EJECUTAR CICLO DE MONITOREO MANUAL
        console.log('\nğŸ”„ [TEST] Ejecutando ciclo de monitoreo manual...');
        await integracion.ejecutarCicloMonitoreo();
        
        // ğŸ“Š MOSTRAR RESULTADOS
        console.log('\nğŸ“Š [TEST] Resultados del monitoreo:');
        const estadoFinal = integracion.obtenerEstadoGlobal();
        
        if (estadoFinal.estadoPsicologicoActual) {
            const { estado_global, estados_individuales } = estadoFinal.estadoPsicologicoActual;
            
            console.log('\nğŸ§  [TEST] Estado psicolÃ³gico global:');
            console.log('ğŸ“Š EmociÃ³n dominante:', estado_global.emocion);
            console.log('ğŸ“Š PuntuaciÃ³n promedio:', estado_global.puntuacion?.toFixed(3) || 'N/A');
            console.log('ğŸ“Š Coherencia promedio:', estado_global.coherencia?.toFixed(3) || 'N/A');
            console.log('ğŸ“Š Confianza promedio:', estado_global.confianza?.toFixed(3) || 'N/A');
            console.log('ğŸ“Š EnergÃ­a promedio:', estado_global.energia?.toFixed(3) || 'N/A');
            console.log('ğŸ“Š Total sÃ­mbolos analizados:', estado_global.total_simbolos || 0);
            
            // ğŸ“ˆ MOSTRAR ESTADOS INDIVIDUALES DE SÃMBOLOS PRINCIPALES
            console.log('\nğŸ“ˆ [TEST] Estados psicolÃ³gicos individuales (sÃ­mbolos principales):');
            const simbolosPrincipales = ['BTCUSDT', 'ETHUSDT', 'BNBUSDT', 'SOLUSDT', 'XRPUSDT'];
            
            for (const symbol of simbolosPrincipales) {
                const estadoIndividual = estados_individuales.find(e => e.symbol === symbol);
                if (estadoIndividual) {
                    const { estado_psicologico, tasas_cambio, quantum_enhanced } = estadoIndividual.estado;
                    console.log(`ğŸ’° ${symbol}:`);
                    console.log(`   ğŸ§  Estado: ${estado_psicologico.emocion} (${estado_psicologico.puntuacion.toFixed(3)})`);
                    console.log(`   ğŸ“Š Tasas cambio: ${tasas_cambio.puntuacion_global.toFixed(3)}`);
                    console.log(`   âš›ï¸ Quantum enhancement: ${quantum_enhanced.quantum_enhancement.toFixed(3)}`);
                    
                    // ğŸ“ˆ MOSTRAR TASAS DE CAMBIO DETALLADAS
                    if (tasas_cambio.precio) {
                        console.log(`   ğŸ’° Precio - Cambio: ${tasas_cambio.precio.cambio_porcentual.toFixed(3)}`);
                        console.log(`   ğŸ’° Precio - AceleraciÃ³n: ${tasas_cambio.precio.aceleracion.toFixed(3)}`);
                        console.log(`   ğŸ’° Precio - Momentum: ${tasas_cambio.precio.momentum.toFixed(3)}`);
                    }
                    
                    if (tasas_cambio.volumen) {
                        console.log(`   ğŸ“Š Volumen - Cambio: ${tasas_cambio.volumen.cambio_porcentual.toFixed(3)}`);
                        console.log(`   ğŸ“Š Volumen - Ratio 24h: ${tasas_cambio.volumen.ratio_24h.toFixed(3)}`);
                        console.log(`   ğŸ“Š Volumen - Intensidad: ${tasas_cambio.volumen.intensidad.toFixed(3)}`);
                    }
                    
                    if (tasas_cambio.funding) {
                        console.log(`   ğŸ’¸ Funding - Tasa: ${tasas_cambio.funding.tasa_actual.toFixed(4)}`);
                        console.log(`   ğŸ’¸ Funding - Cambio: ${tasas_cambio.funding.cambio_porcentual.toFixed(3)}`);
                        console.log(`   ğŸ’¸ Funding - PresiÃ³n: ${tasas_cambio.funding.presion}`);
                    }
                    
                    if (tasas_cambio.volatilidad) {
                        console.log(`   ğŸ“ˆ Volatilidad - Nivel: ${tasas_cambio.volatilidad.nivel_actual.toFixed(3)}`);
                        console.log(`   ğŸ“ˆ Volatilidad - Riesgo: ${tasas_cambio.volatilidad.riesgo.toFixed(3)}`);
                        console.log(`   ğŸ“ˆ Volatilidad - Spike: ${tasas_cambio.volatilidad.spike ? 'SÃ' : 'NO'}`);
                    }
                } else {
                    console.log(`ğŸ’° ${symbol}: No disponible`);
                }
            }
        }
        
        // ğŸ¯ MOSTRAR OPORTUNIDADES DETECTADAS
        console.log('\nğŸ¯ [TEST] Oportunidades detectadas:');
        const oportunidades = integracion.obtenerOportunidades();
        
        if (oportunidades.length > 0) {
            oportunidades.forEach((oportunidad, index) => {
                console.log(`\n${index + 1}. ${oportunidad.symbol}:`);
                console.log(`   ğŸ¯ Tipo: ${oportunidad.tipo}`);
                console.log(`   ğŸ§  Estado psicolÃ³gico: ${oportunidad.estado_psicologico}`);
                console.log(`   ğŸ“Š Score: ${oportunidad.score.toFixed(3)}`);
                console.log(`   ğŸ“Š PuntuaciÃ³n psicolÃ³gica: ${oportunidad.puntuacion_psicologica.toFixed(3)}`);
                console.log(`   ğŸ“Š Tasas de cambio: ${oportunidad.tasas_cambio.toFixed(3)}`);
                console.log(`   âš›ï¸ Quantum enhancement: ${oportunidad.quantum_enhancement.toFixed(3)}`);
            });
        } else {
            console.log('âŒ No se detectaron oportunidades');
        }
        
        // ğŸš¨ MOSTRAR ALERTAS ACTIVAS
        console.log('\nğŸš¨ [TEST] Alertas activas:');
        const alertas = integracion.obtenerAlertas();
        
        if (alertas.length > 0) {
            alertas.forEach((alerta, index) => {
                console.log(`\n${index + 1}. ${alerta.tipo} (${alerta.severidad}):`);
                console.log(`   ğŸ“ ${alerta.mensaje}`);
                if (alerta.simbolo) {
                    console.log(`   ğŸ’° SÃ­mbolo: ${alerta.simbolo}`);
                }
                console.log(`   â° ${alerta.timestamp}`);
            });
        } else {
            console.log('âœ… No hay alertas activas');
        }
        
        // ğŸ“Š MOSTRAR MÃ‰TRICAS GLOBALES
        console.log('\nğŸ“Š [TEST] MÃ©tricas globales:');
        const metricas = estadoFinal.metricasGlobales;
        
        if (metricas) {
            console.log('ğŸ“Š Total sÃ­mbolos analizados:', metricas.total_simbolos_analizados || 0);
            console.log('ğŸ“Š Estado psicolÃ³gico promedio:', metricas.estado_psicologico_promedio?.toFixed(3) || 'N/A');
            console.log('ğŸ“Š EmociÃ³n dominante:', metricas.emocion_dominante || 'N/A');
            console.log('ğŸ“Š Oportunidades detectadas:', metricas.oportunidades_detectadas || 0);
            console.log('ğŸ“Š Alertas activas:', metricas.alertas_activas || 0);
        }
        
        // ğŸ¯ EVALUAR RESULTADO FINAL
        console.log('\nğŸ¯ [TEST] EvaluaciÃ³n del resultado:');
        
        if (estadoFinal.estadoPsicologicoActual?.estado_global) {
            const puntuacion = estadoFinal.estadoPsicologicoActual.estado_global.puntuacion;
            const oportunidades = estadoFinal.oportunidadesDetectadas.length;
            const alertas = estadoFinal.alertasPsicologicas.length;
            
            if (puntuacion > 0.7) {
                console.log('âœ… EXCELENTE - Estado psicolÃ³gico muy favorable');
            } else if (puntuacion > 0.5) {
                console.log('ğŸŸ¡ BUENO - Estado psicolÃ³gico moderado');
            } else {
                console.log('ğŸ”´ BAJO - Estado psicolÃ³gico desfavorable');
            }
            
            if (oportunidades > 0) {
                console.log(`âœ… OPORTUNIDADES - ${oportunidades} oportunidades detectadas`);
            } else {
                console.log('âš ï¸ SIN OPORTUNIDADES - No se detectaron oportunidades');
            }
            
            if (alertas > 0) {
                console.log(`ğŸš¨ ALERTAS - ${alertas} alertas activas`);
            } else {
                console.log('âœ… SIN ALERTAS - Sistema estable');
            }
        }
        
        console.log('\nğŸ‰ [TEST INTEGRACIÃ“N COMPLETA] Prueba completada exitosamente!');
        
        // ğŸ”„ CONTINUAR MONITOREO POR 30 SEGUNDOS
        console.log('\nğŸ”„ [TEST] Continuando monitoreo por 30 segundos...');
        await new Promise(resolve => setTimeout(resolve, 30000));
        
        // ğŸ“Š MOSTRAR ESTADO FINAL
        console.log('\nğŸ“Š [TEST] Estado final despuÃ©s de 30 segundos:');
        const estadoFinal30s = integracion.obtenerEstadoGlobal();
        console.log('âœ… Ãšltima actualizaciÃ³n:', estadoFinal30s.ultimaActualizacion || 'N/A');
        console.log('ğŸ§  Estado psicolÃ³gico:', estadoFinal30s.estadoPsicologicoActual?.estado_global?.emocion || 'N/A');
        console.log('ğŸ¯ Oportunidades detectadas:', estadoFinal30s.oportunidadesDetectadas?.length || 0);
        console.log('ğŸš¨ Alertas activas:', estadoFinal30s.alertasPsicologicas?.length || 0);
        
        console.log('\nğŸ‰ [TEST INTEGRACIÃ“N COMPLETA] Prueba finalizada exitosamente!');
        
    } catch (error) {
        console.error('âŒ [TEST INTEGRACIÃ“N COMPLETA] Error durante la prueba:', error.message);
        console.error('Stack trace:', error.stack);
    }
}

// ğŸš€ EJECUTAR PRUEBA
testIntegracionCompleta();
