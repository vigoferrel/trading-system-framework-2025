// ============================================================================
// TEST DE ADAPTACIÃ“N DE RÃ‰GIMEN - VERIFICACIÃ“N DE UMBRALES DINÃMICOS
// ============================================================================

const axios = require('axios');

async function testRegimeAdaptation() {
    console.log('ğŸ§ª [TEST] Iniciando prueba de adaptaciÃ³n de rÃ©gimen...\n');
    
    try {
        // PASO 1: Verificar conectividad del servidor
        console.log('ğŸ“¡ [TEST] Verificando conectividad del servidor...');
        const healthResponse = await axios.get('http://localhost:4602/api/enhanced-opportunities', { timeout: 5000 });
        console.log('âœ… [TEST] Servidor conectado correctamente\n');
        
        // PASO 2: Probar endpoint de consolidaciÃ³n
        console.log('ğŸ”„ [TEST] Probando endpoint de consolidaciÃ³n...');
        const consolidationResponse = await axios.get('http://localhost:4602/api/consolidated-recommendations', { timeout: 15000 });
        
        if (consolidationResponse.data.success) {
            const data = consolidationResponse.data.data;
            console.log('âœ… [TEST] ConsolidaciÃ³n exitosa');
            console.log(`ğŸ“Š [TEST] RÃ©gimen detectado: ${data.summary.marketRegime}`);
            console.log(`âš™ï¸ [TEST] Umbrales aplicados: Score=${data.summary.regimeThresholds.minScore}%, Confianza=${data.summary.regimeThresholds.minConfidence}%`);
            console.log(`ğŸ“ˆ [TEST] Recomendaciones generadas: ${data.recommendations.length}`);
            console.log(`ğŸ¥ [TEST] Salud del sistema: ${data.summary.systemHealth}`);
            console.log(`ğŸ¯ [TEST] RazÃ³n de adaptaciÃ³n: ${data.summary.regimeAdaptation.adaptationReason}\n`);
            
            // PASO 3: Verificar fuentes individuales
            console.log('ğŸ” [TEST] Verificando fuentes individuales...');
            const sources = [
                { name: 'Enhanced Opportunities', url: '/api/enhanced-opportunities' },
                { name: 'Quantum Recommendations', url: '/api/quantum-recommendations' },
                { name: 'Quantum Brain', url: '/api/quantum-brain-test' },
                { name: 'Quantum Analysis', url: '/api/quantum-analysis' }
            ];
            
            for (const source of sources) {
                try {
                    const response = await axios.get(`http://localhost:4602${source.url}`, { timeout: 10000 });
                    const dataCount = getDataCount(response.data);
                    console.log(`âœ… [TEST] ${source.name}: ${dataCount} elementos`);
                } catch (error) {
                    console.log(`âŒ [TEST] ${source.name}: Error - ${error.message}`);
                }
            }
            
            // PASO 4: AnÃ¡lisis de mÃ©tricas de rÃ©gimen
            console.log('\nğŸ“Š [TEST] AnÃ¡lisis de mÃ©tricas de rÃ©gimen...');
            if (data.summary.marketRegime) {
                console.log(`ğŸ¯ [TEST] RÃ©gimen actual: ${data.summary.marketRegime}`);
                console.log(`ğŸ“ [TEST] Umbrales configurados:`);
                console.log(`   - Score mÃ­nimo: ${data.summary.regimeThresholds.minScore}%`);
                console.log(`   - Confianza mÃ­nima: ${data.summary.regimeThresholds.minConfidence}%`);
                console.log(`   - MÃ¡ximo recomendaciones: ${data.summary.regimeThresholds.maxRecommendations}`);
                console.log(`   - Bonus confianza: ${data.summary.regimeThresholds.confidenceBonus}`);
                console.log(`   - Bonus fuentes: ${data.summary.regimeThresholds.sourceBonus}`);
            }
            
            // PASO 5: Verificar top recomendaciones
            if (data.recommendations.length > 0) {
                console.log('\nğŸ† [TEST] Top 3 recomendaciones:');
                data.recommendations.slice(0, 3).forEach((rec, index) => {
                    console.log(`   ${index + 1}. ${rec.symbol} - ${rec.action} (${rec.confidence}) - ${rec.priority} priority`);
                });
            } else {
                console.log('\nâš ï¸ [TEST] No hay recomendaciones generadas');
                console.log('ğŸ’¡ [TEST] Esto puede ser debido a:');
                console.log('   - Fuentes individuales sin datos');
                console.log('   - Umbrales muy estrictos');
                console.log('   - Rate limiting de Binance');
            }
            
        } else {
            console.log('âŒ [TEST] Error en consolidaciÃ³n:', consolidationResponse.data.error);
        }
        
    } catch (error) {
        console.error('âŒ [TEST] Error en prueba:', error.message);
    }
}

function getDataCount(data) {
    if (data.opportunities) return data.opportunities.length;
    if (data.recommendations) return data.recommendations.length;
    if (data.brainRecommendations) return data.brainRecommendations.length;
    if (data.quantumRecommendations) return data.quantumRecommendations.length;
    if (data.brainAnalysis) return Object.keys(data.brainAnalysis).length;
    return 0;
}

// Ejecutar prueba
testRegimeAdaptation().then(() => {
    console.log('\nâœ… [TEST] Prueba completada');
    process.exit(0);
}).catch(error => {
    console.error('\nâŒ [TEST] Prueba fallida:', error.message);
    process.exit(1);
});
