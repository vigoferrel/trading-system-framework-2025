/**
 * TEST QUANTUM OPPORTUNITY SCANNER
 * ================================
 * 
 * Prueba del sistema Quantum Opportunity Scanner con datos reales
 */

const { startQuantumOpportunityScanner } = require('./quantum-opportunity-scanner.js');

async function testQuantumScanner() {
    console.log('ðŸ§ª [TEST QUANTUM SCANNER] Iniciando prueba del Quantum Opportunity Scanner...');
    
    try {
        // INICIALIZAR SCANNER
        const scanner = await startQuantumOpportunityScanner();
        
        console.log('âœ… [TEST QUANTUM SCANNER] Scanner inicializado correctamente');
        
        // PRUEBA 1: QUICK SCAN
        console.log('\nðŸ” [TEST QUANTUM SCANNER] Ejecutando QUICK SCAN...');
        const quickScan = await scanner.scanOpportunities('QUICK', 5);
        
        console.log('ðŸ“Š [TEST QUANTUM SCANNER] Resultados QUICK SCAN:');
        console.log(`- SÃ­mbolos escaneados: ${quickScan.symbols_scanned}`);
        console.log(`- Oportunidades encontradas: ${quickScan.opportunities_found}`);
        console.log(`- DuraciÃ³n del scan: ${quickScan.scan_duration_ms}ms`);
        
        if (quickScan.opportunities.length > 0) {
            console.log('\nðŸ† [TEST QUANTUM SCANNER] Top Oportunidades:');
            quickScan.opportunities.forEach((opp, index) => {
                console.log(`${index + 1}. ${opp.symbol} - Score: ${opp.opportunity_score.total_score.toFixed(3)} - Grade: ${opp.opportunity_score.opportunity_grade}`);
            });
        }
        
        // PRUEBA 2: FULL SCAN (si hay tiempo)
        console.log('\nðŸ” [TEST QUANTUM SCANNER] Ejecutando FULL SCAN...');
        const fullScan = await scanner.scanOpportunities('FULL', 10);
        
        console.log('ðŸ“Š [TEST QUANTUM SCANNER] Resultados FULL SCAN:');
        console.log(`- SÃ­mbolos escaneados: ${fullScan.symbols_scanned}`);
        console.log(`- Oportunidades encontradas: ${fullScan.opportunities_found}`);
        console.log(`- DuraciÃ³n del scan: ${fullScan.scan_duration_ms}ms`);
        
        // PRUEBA 3: ANÃLISIS DETALLADO DE TOP OPORTUNIDAD
        if (fullScan.opportunities.length > 0) {
            const topOpportunity = fullScan.opportunities[0];
            console.log('\nðŸ”¬ [TEST QUANTUM SCANNER] AnÃ¡lisis detallado de top oportunidad:');
            console.log(`SÃ­mbolo: ${topOpportunity.symbol}`);
            console.log(`Score total: ${topOpportunity.opportunity_score.total_score.toFixed(3)}`);
            console.log(`Grade: ${topOpportunity.opportunity_score.opportunity_grade}`);
            console.log(`Conviction: ${topOpportunity.opportunity_score.conviction_level}`);
            console.log(`Risk Level: ${topOpportunity.opportunity_score.risk_level}`);
            console.log(`Risk/Reward: ${topOpportunity.opportunity_score.risk_reward_estimate}`);
            
            // COMPONENTES DEL SCORE
            console.log('\nðŸ“ˆ [TEST QUANTUM SCANNER] Componentes del Score:');
            Object.entries(topOpportunity.opportunity_score.components).forEach(([component, score]) => {
                console.log(`- ${component}: ${score.toFixed(3)}`);
            });
            
            // ANÃLISIS TÃ‰CNICO
            if (topOpportunity.analysis.technical) {
                console.log('\nðŸ“Š [TEST QUANTUM SCANNER] AnÃ¡lisis TÃ©cnico:');
                console.log(`- RSI 1H: ${topOpportunity.analysis.technical.rsi['1h'].toFixed(1)}`);
                console.log(`- RSI 4H: ${topOpportunity.analysis.technical.rsi['4h'].toFixed(1)}`);
                console.log(`- RSI 1D: ${topOpportunity.analysis.technical.rsi['1d'].toFixed(1)}`);
                console.log(`- Volume Spike: ${topOpportunity.analysis.technical.volume_spike.toFixed(2)}x`);
                console.log(`- Technical Score: ${topOpportunity.analysis.technical.technical_score.toFixed(3)}`);
            }
            
            // ANÃLISIS SMART MONEY
            if (topOpportunity.analysis.smart_money) {
                console.log('\nðŸ‹ [TEST QUANTUM SCANNER] AnÃ¡lisis Smart Money:');
                console.log(`- Large Bids: ${topOpportunity.analysis.smart_money.large_orders.large_bids.length}`);
                console.log(`- Large Asks: ${topOpportunity.analysis.smart_money.large_orders.large_asks.length}`);
                console.log(`- Institutional Orders: ${topOpportunity.analysis.smart_money.large_orders.institutional_orders}`);
                console.log(`- Trade Flow: ${topOpportunity.analysis.smart_money.trade_flow.flow_direction}`);
                console.log(`- Smart Money Score: ${topOpportunity.analysis.smart_money.smart_money_score.toFixed(3)}`);
            }
            
            // ANÃLISIS DE ESTRUCTURA
            if (topOpportunity.analysis.structure) {
                console.log('\nðŸ—ï¸ [TEST QUANTUM SCANNER] AnÃ¡lisis de Estructura:');
                console.log(`- Structure Type: ${topOpportunity.analysis.structure.structure.structure_type}`);
                console.log(`- Higher Highs: ${topOpportunity.analysis.structure.structure.higher_highs}`);
                console.log(`- Lower Lows: ${topOpportunity.analysis.structure.structure.lower_lows}`);
                console.log(`- Breakouts: ${topOpportunity.analysis.structure.structure.breakouts.length}`);
                console.log(`- Structure Score: ${topOpportunity.analysis.structure.structure_score.toFixed(3)}`);
            }
            
            // ANÃLISIS DE SENTIMENT
            if (topOpportunity.analysis.sentiment) {
                console.log('\nðŸ§  [TEST QUANTUM SCANNER] AnÃ¡lisis de Sentiment:');
                console.log(`- Funding Rate: ${(topOpportunity.analysis.sentiment.funding_rate * 100).toFixed(4)}%`);
                console.log(`- Avg Funding Rate: ${(topOpportunity.analysis.sentiment.avg_funding_rate * 100).toFixed(4)}%`);
                console.log(`- Sentiment Direction: ${topOpportunity.analysis.sentiment.sentiment.direction}`);
                console.log(`- Squeeze Potential: ${topOpportunity.analysis.sentiment.sentiment.squeeze_potential.toFixed(2)}`);
                console.log(`- Sentiment Score: ${topOpportunity.analysis.sentiment.sentiment_score.toFixed(3)}`);
            }
            
            // ANÃLISIS DE CONFLUENCIA
            if (topOpportunity.analysis.confluence) {
                console.log('\nâœ¨ [TEST QUANTUM SCANNER] AnÃ¡lisis de Confluencia:');
                console.log(`- Overall Confluence: ${topOpportunity.analysis.confluence.overall_confluence.toFixed(3)}`);
                console.log(`- Score Variance: ${topOpportunity.analysis.confluence.score_variance.toFixed(3)}`);
                console.log(`- Confluence Quality: ${topOpportunity.analysis.confluence.confluence_quality}`);
            }
        }
        
        // RESUMEN FINAL
        console.log('\nðŸ“‹ [TEST QUANTUM SCANNER] Resumen Final:');
        console.log(`âœ… Scanner funcionando correctamente`);
        console.log(`âœ… Datos reales de Binance obtenidos`);
        console.log(`âœ… AnÃ¡lisis multi-dimensional completado`);
        console.log(`âœ… Rate limiting respetado`);
        console.log(`âœ… Sin simulaciones - solo datos reales`);
        
        console.log('\nðŸŽ¯ [TEST QUANTUM SCANNER] Prueba completada exitosamente!');
        
    } catch (error) {
        console.error('âŒ [TEST QUANTUM SCANNER] Error en la prueba:', error);
        console.error('Stack trace:', error.stack);
    }
}

// EJECUTAR PRUEBA
if (require.main === module) {
    testQuantumScanner().then(() => {
        console.log('\nðŸ [TEST QUANTUM SCANNER] Prueba finalizada');
        process.exit(0);
    }).catch(error => {
        console.error('\nðŸ’¥ [TEST QUANTUM SCANNER] Prueba fallÃ³:', error);
        process.exit(1);
    });
}

module.exports = { testQuantumScanner };
