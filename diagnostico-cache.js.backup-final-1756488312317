const axios = require('axios');

console.log('[SEARCH] DIAGNSTICO DE CACHE Y RATE LIMITING - BANDA 46');
console.log('=' .repeat(60));

// Funci贸n para verificar el estado de la cach茅
async function verificarCache() {
    console.log('\n[DATA] VERIFICANDO ESTADO DE CACHE...');
    
    try {
        // Verificar QBTC Core
        const qbtcResponse = await axios.get('http://localhost:4602/health', { timeout: 5000 });
        console.log('[OK] QBTC Core est谩 activo');
        
        // Verificar datos de futuros
        const futuresResponse = await axios.get('http://localhost:4602/api/futures-data', { timeout: 5000 });
        console.log('[OK] Datos de futuros disponibles');
        
        // Verificar timestamp de la cach茅
        if (futuresResponse.data && futuresResponse.data.cacheStatus) {
            console.log(` Estado de cach茅: ${futuresResponse.data.cacheStatus}`);
        }
        
        return true;
    } catch (error) {
        console.log('[ERROR] QBTC Core no est谩 activo o no responde');
        return false;
    }
}

// Funci贸n para verificar rate limiting directo con Binance
async function verificarRateLimiting() {
    console.log('\n VERIFICANDO RATE LIMITING CON BINANCE...');
    
    try {
        const response = await axios.get('https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=BTCUSDT', {
            timeout: 10000,
            headers: {
                'User-Agent': 'QBTC-Diagnostic/1.0',
                'Accept': 'application/json'
            }
        });
        
        console.log('[OK] Conexi贸n directa a Binance exitosa');
        console.log(`[DATA] Datos recibidos: ${response.data.symbol} - Precio: $${response.data.lastPrice}`);
        
        // Verificar headers de rate limiting
        const rateLimitHeaders = {
            'X-MBX-USED-WEIGHT-1M': response.headers['x-mbx-used-weight-1m'],
            'X-MBX-ORDER-COUNT-1M': response.headers['x-mbx-order-count-1m'],
            'Retry-After': response.headers['retry-after']
        };
        
        console.log('[LIST] Headers de rate limiting:', rateLimitHeaders);
        
        return true;
    } catch (error) {
        if (error.response) {
            console.log(`[ERROR] Error de Binance: ${error.response.status} - ${error.response.statusText}`);
            
            if (error.response.status === 418) {
                console.log('[ALERT] RATE LIMITING DETECTADO - Binance est谩 bloqueando requests');
                if (error.response.headers['retry-after']) {
                    console.log(`[TIME] Tiempo de espera sugerido: ${error.response.headers['retry-after']} segundos`);
                }
            }
        } else {
            console.log(`[ERROR] Error de conexi贸n: ${error.message}`);
        }
        return false;
    }
}

// Funci贸n para verificar el estado de todos los servicios
async function verificarServicios() {
    console.log('\n VERIFICANDO ESTADO DE SERVICIOS...');
    
    const servicios = [
        { nombre: 'QBTC Core', puerto: 4602, endpoint: '/health' },
        { nombre: 'Monitor de Gr谩ficos', puerto: 4606, endpoint: '/health' },
        { nombre: 'SRONA API', puerto: 4601, endpoint: '/health' },
        { nombre: 'Frontend API', puerto: 4603, endpoint: '/health' },
        { nombre: 'Vigo Futures', puerto: 4604, endpoint: '/health' },
        { nombre: 'Dashboard QBTC', puerto: 4605, endpoint: '/health' }
    ];
    
    for (const servicio of servicios) {
        try {
            const response = await axios.get(`http://localhost:${servicio.puerto}${servicio.endpoint}`, { timeout: 3000 });
            console.log(`[OK] ${servicio.nombre} (puerto ${servicio.puerto}): ACTIVO`);
        } catch (error) {
            console.log(`[ERROR] ${servicio.nombre} (puerto ${servicio.puerto}): NO ACTIVO`);
        }
    }
}

// Funci贸n para verificar la configuraci贸n de cach茅 en el c贸digo
function verificarConfiguracionCache() {
    console.log('\n锔 VERIFICANDO CONFIGURACIN DE CACHE...');
    
    // Simular la configuraci贸n actual
    const cacheConfig = {
        spot: { cacheTime: 2000 }, // 2 segundos
        futures: { cacheTime: 600000 }, // 10 minutos
        options: { cacheTime: 5000 } // 5 segundos
    };
    
    console.log('[LIST] Configuraci贸n actual de cach茅:');
    console.log(`   SPOT: ${cacheConfig.spot.cacheTime}ms (${cacheConfig.spot.cacheTime/1000}s)`);
    console.log(`   FUTURES: ${cacheConfig.futures.cacheTime}ms (${cacheConfig.futures.cacheTime/60000}min)`);
    console.log(`   OPTIONS: ${cacheConfig.options.cacheTime}ms (${cacheConfig.options.cacheTime/1000}s)`);
    
    // Verificar si la configuraci贸n es apropiada
    if (cacheConfig.futures.cacheTime < 300000) { // Menos de 5 minutos
        console.log('[WARNING] ADVERTENCIA: Cache de futuros muy corta, puede causar rate limiting');
    } else {
        console.log('[OK] Cache de futuros configurada apropiadamente para evitar rate limiting');
    }
}

// Funci贸n principal
async function diagnosticoCompleto() {
    console.log('[START] Iniciando diagn贸stico completo...\n');
    
    // Verificar configuraci贸n
    verificarConfiguracionCache();
    
    // Verificar servicios
    await verificarServicios();
    
    // Verificar rate limiting
    await verificarRateLimiting();
    
    // Verificar cach茅
    await verificarCache();
    
    console.log('\n' + '=' .repeat(60));
    console.log(' DIAGNSTICO COMPLETADO');
    console.log('\n RECOMENDACIONES:');
    console.log('1. Si QBTC Core no est谩 activo, ejecutar: node core-system-organized.js');
    console.log('2. Si hay rate limiting, esperar antes de hacer m谩s requests');
    console.log('3. Verificar que la cach茅 est茅 funcionando correctamente');
    console.log('4. Si los servicios no est谩n activos, ejecutar: python deploy-banda-46-fixed.py');
}

// Ejecutar diagn贸stico
diagnosticoCompleto().catch(error => {
    console.error('[ERROR] Error durante el diagn贸stico:', error.message);
});
