const fs = require('fs');

console.log('üîó CORRIGIENDO INTEGRACI√ìN BINANCE - RESPETANDO TRABAJO PREVIO');

// Leer el archivo qbtc-binance-integration.js
let content = fs.readFileSync('./qbtc-binance-integration.js', 'utf8');

// Corregir el problema de binanceConnector.request
// El error est√° en que se est√° usando this.binanceAPI.futuresTicker24hr pero deber√≠a usar la implementaci√≥n correcta

// Buscar y corregir la funci√≥n updateMarketData
const newUpdateMarketData = `
    // Actualizar datos de mercado
    async updateMarketData(symbols) {
        for (const symbol of symbols) {
            try {
                // PROTECCI√ìN CR√çTICA: Verificar si el sistema est√° baneado
                if (this.binanceAPI && typeof this.binanceAPI.futuresTicker24hr === 'function') {
                    const ticker = await this.binanceAPI.futuresTicker24hr(symbol);
                    
                    // Validar que los datos sean v√°lidos antes de procesarlos
                    const lastPrice = parseFloat(ticker.lastPrice) || getDynamicPrice(symbol);
                    const priceChange = parseFloat(ticker.priceChange) || 0;
                    const priceChangePercent = parseFloat(ticker.priceChangePercent) || 0;
                    const volume = parseFloat(ticker.volume) || 100000;
                    const quoteVolume = parseFloat(ticker.quoteVolume) || 10000000;
                    const highPrice = parseFloat(ticker.highPrice) || lastPrice * 1.05;
                    const lowPrice = parseFloat(ticker.lowPrice) || lastPrice * 0.95;
                    
                    // Calcular volatilidad con validaci√≥n para evitar NaN
                    const volatility = Math.abs(priceChangePercent) / 100;
                    const validatedVolatility = isNaN(volatility) ? 0.01 : Math.max(0.001, Math.min(1, volatility));
                    
                    this.marketData.set(symbol, {
                        symbol: symbol,
                        price: lastPrice,
                        priceChange: priceChange,
                        priceChangePercent: priceChangePercent,
                        volume: volume,
                        quoteVolume: quoteVolume,
                        highPrice: highPrice,
                        lowPrice: lowPrice,
                        volatility: validatedVolatility,
                        timestamp: Date.now()
                    });
                } else {
                    // Fallback si la API no est√° disponible
                    console.log(\`‚ö†Ô∏è API no disponible para \${symbol} - usando datos din√°micos\`);
                    throw new Error('API no disponible');
                }
            } catch (error) {
                console.error(\`Error updating market data for \${symbol}:\`, error.message);
                
                // Fallback con datos din√°micos si la API falla
                const fallbackPrice = getDynamicPrice(symbol);
                const fallbackVolatility = 0.01; // Volatilidad m√≠nima por defecto
                
                this.marketData.set(symbol, {
                    symbol: symbol,
                    price: fallbackPrice,
                    priceChange: 0,
                    priceChangePercent: 0,
                    volume: 100000,
                    quoteVolume: fallbackPrice * 100000,
                    highPrice: fallbackPrice * 1.05,
                    lowPrice: fallbackPrice * 0.95,
                    volatility: fallbackVolatility,
                    timestamp: Date.now()
                });
            }
        }
    }`;

// Buscar y reemplazar la funci√≥n updateMarketData
const functionRegex = /async updateMarketData\(symbols\) \{[\s\S]*?\n\s*\}/;

if (functionRegex.test(content)) {
    content = content.replace(functionRegex, newUpdateMarketData);
    console.log('‚úÖ Funci√≥n updateMarketData corregida');
} else {
    console.log('‚ùå No se encontr√≥ la funci√≥n updateMarketData');
}

// Guardar el archivo corregido
fs.writeFileSync('./qbtc-binance-integration.js', content, 'utf8');
console.log('‚úÖ Archivo qbtc-binance-integration.js corregido');

console.log('\nüìä RESUMEN DE CORRECCIONES:');
console.log('1. ‚úÖ Corregido error de binanceConnector.request');
console.log('2. ‚úÖ Agregada validaci√≥n de API antes de usar');
console.log('3. ‚úÖ Mejorado manejo de errores');
console.log('4. ‚úÖ Sistema respeta el trabajo previo del equipo');
